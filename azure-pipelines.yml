# Azure DevOps pipeline example
# - Stores secrets in pipeline variables (Library) or Key Vault
# - Runs Playwright tests and publishes the HTML report as an artifact
#
# TIP: If you use Microsoft-hosted agents, Playwright can install browsers with:
#   npx playwright install --with-deps
# But you can also cache browsers between runs if needed.

trigger:
- main

pool:
  vmImage: 'ubuntu-latest'

variables:
  NODE_VERSION: '24.11.0' # Use the Node.js version compatible with your project

steps:
- task: NodeTool@0
  inputs:
    versionSpec: '$(NODE_VERSION)'
  displayName: 'Use Node.js $(NODE_VERSION)'

- script: |
    npm ci
  displayName: 'Install dependencies'

- script: |
    npx playwright install --with-deps
  displayName: 'Install Playwright browsers'

# Run setup projects first
- script: |
    rm -rf playwright-report test-results
    echo "Running setup projects..."
    npx playwright test --project=setup-editor --project=setup-admin --project=setup-visitor
  displayName: 'Run setup projects'
  env:
    CI: 'true'
    PW_ENV: 'dev'
    BASE_URL_SITE: '$(BASE_URL_SITE)'
    BASE_URL_CMS: '$(BASE_URL_CMS)'
    OPTIMIZELY_CMS_EDITOR_TOKEN: '$(OPTIMIZELY_CMS_EDITOR_TOKEN)'
    OPTIMIZELY_CMS_ADMIN_TOKEN: '$(OPTIMIZELY_CMS_ADMIN_TOKEN)'
    PERCY_TOKEN: '$(PERCY_TOKEN)'

# Run pagetype and publish results/report
- script: |
    rm -rf playwright-report test-results
    echo "Running pagetype project..."
    npx playwright test --project=pagetype
  displayName: 'Run pagetype tests'
  condition: succeededOrFailed()
  env:
    CI: 'true'
    PW_ENV: 'dev'
    BASE_URL_SITE: '$(BASE_URL_SITE)'
    BASE_URL_CMS: '$(BASE_URL_CMS)'
    OPTIMIZELY_CMS_EDITOR_TOKEN: '$(OPTIMIZELY_CMS_EDITOR_TOKEN)'
    OPTIMIZELY_CMS_ADMIN_TOKEN: '$(OPTIMIZELY_CMS_ADMIN_TOKEN)'
    PERCY_TOKEN: '$(PERCY_TOKEN)'

- task: PublishTestResults@2
  inputs:
    testResultsFormat: 'JUnit'
    testResultsFiles: 'test-results/junit.xml'
    failTaskOnFailedTests: true
    failTaskOnMissingResultsFile: false
  condition: succeededOrFailed()
  displayName: 'Publish pagetype test results'

- task: PublishPipelineArtifact@1
  inputs:
    targetPath: 'playwright-report'
    artifactName: 'playwright-report-pagetype'
  condition: succeededOrFailed()
  displayName: 'Publish pagetype HTML report'

# Run redirect and publish results/report
- script: |
    rm -rf playwright-report test-results
    echo "Running redirect project..."
    npx playwright test --project=redirect
  displayName: 'Run redirect tests'
  condition: succeededOrFailed()
  env:
    CI: 'true'
    PW_ENV: 'dev'
    BASE_URL_SITE: '$(BASE_URL_SITE)'
    BASE_URL_CMS: '$(BASE_URL_CMS)'
    OPTIMIZELY_CMS_EDITOR_TOKEN: '$(OPTIMIZELY_CMS_EDITOR_TOKEN)'
    OPTIMIZELY_CMS_ADMIN_TOKEN: '$(OPTIMIZELY_CMS_ADMIN_TOKEN)'
    PERCY_TOKEN: '$(PERCY_TOKEN)'

- task: PublishTestResults@2
  inputs:
    testResultsFormat: 'JUnit'
    testResultsFiles: 'test-results/junit.xml'
    failTaskOnFailedTests: true
    failTaskOnMissingResultsFile: false
  condition: succeededOrFailed()
  displayName: 'Publish redirect test results'

- task: PublishPipelineArtifact@1
  inputs:
    targetPath: 'playwright-report'
    artifactName: 'playwright-report-redirect'
  condition: succeededOrFailed()
  displayName: 'Publish redirect HTML report'

# Run site and publish results/report
- script: |
    rm -rf playwright-report test-results
    echo "Running site project..."
    npx playwright test --project=site
  displayName: 'Run site tests'
  condition: succeededOrFailed()
  env:
    CI: 'true'
    PW_ENV: 'dev'
    BASE_URL_SITE: '$(BASE_URL_SITE)'
    BASE_URL_CMS: '$(BASE_URL_CMS)'
    OPTIMIZELY_CMS_EDITOR_TOKEN: '$(OPTIMIZELY_CMS_EDITOR_TOKEN)'
    OPTIMIZELY_CMS_ADMIN_TOKEN: '$(OPTIMIZELY_CMS_ADMIN_TOKEN)'
    PERCY_TOKEN: '$(PERCY_TOKEN)'

- task: PublishTestResults@2
  inputs:
    testResultsFormat: 'JUnit'
    testResultsFiles: 'test-results/junit.xml'
    failTaskOnFailedTests: true
    failTaskOnMissingResultsFile: false
  condition: succeededOrFailed()
  displayName: 'Publish site test results'

- task: PublishPipelineArtifact@1
  inputs:
    targetPath: 'playwright-report'
    artifactName: 'playwright-report-site'
  condition: succeededOrFailed()
  displayName: 'Publish site HTML report'
